# syntax=docker/dockerfile:1.7
# ---- Dockerfile.dev (local development) ----
# Same behavior as production, but adds BuildKit cache mounts for fast rebuilds.
# Requires BuildKit enabled locally: DOCKER_BUILDKIT=1

# ---- build stage ----
FROM eclipse-temurin:25-jdk AS build
WORKDIR /app

# Copy Gradle wrapper FIRST so layers cache well
COPY gradlew gradlew.bat ./
COPY gradle/wrapper/ ./gradle/wrapper/

# Build scripts (dependency graph inputs)
COPY settings.gradle.kts build.gradle.kts ./

# Download and cache Gradle artifacts between builds.
# This is the strongest local cache because it reuses Gradle's real caches.
RUN --mount=type=cache,target=/root/.gradle \
    chmod +x gradlew && ./gradlew --no-daemon -x test help

# Sources (change most often)
COPY src ./src

# Build the Spring Boot executable jar (bootJar).
# Gradle config sets bootJar archiveFileName to app.jar.
RUN --mount=type=cache,target=/root/.gradle \
    ./gradlew --no-daemon -x test clean bootJar

# ---- runtime stage ----
FROM eclipse-temurin:25-jre
WORKDIR /app

# Copy the single boot jar output (no wildcards).
COPY --from=build /app/build/libs/app.jar app.jar

ENV JAVA_OPTS=""
EXPOSE 8080
ENTRYPOINT ["sh","-c","java $JAVA_OPTS -jar /app/app.jar"]
